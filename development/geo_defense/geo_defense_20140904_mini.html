
<div id="app"></div>
<script>

(function(){var e,t,n,r,i,s,o,u,a,f="start",l=new Date,c=1,h;window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}()),e={distance:function(e,t,n,r){return Math.sqrt(Math.pow(e-n,2)+Math.pow(t-r,2))},percent:function(e,t){return e*100/t},findAngles:function(e,t){var n={};return n.clock=e-t,n.counter=t-e,n.clock<0&&(n.clock+=Math.PI*2),n.counter<0&&(n.counter+=Math.PI*2),n}},o=function(e,t,n,r){var i=0,s=t.length,o,u;this.canvas=[],this.context=[],this.width=n,this.height=r,this.layerNames={};while(i<s)o=document.createElement("canvas"),o.style.position="absolute",u=o.getContext("2d"),o.width=n,o.height=r,document.getElementById(e).appendChild(o),this.canvas.push(o),this.context.push(u),this.layerNames[t[i]]=i,i++},o.prototype={get:function(e,t){t===undefined&&(t="context");if(typeof e=="number")return this[t][e];if(typeof e=="string")return this[t][this.layerNames[e]]},render:function(e,t){var n=this.get(e),r=0,i=t.length;while(r<i){switch(typeof n[t[r]]){case"string":n[t[r]]=t[r+1];break;case"function":n[t[r]].apply(n,t[r+1].split(","))}r+=2}},clear:function(e){this.context[e].clearRect(0,0,this.canvas[e].width,this.canvas[e].height)},fillTo:function(e,t){this.context[e].fillStyle=t,this.context[e].fillRect(0,0,this.canvas[e].width,this.canvas[e].height)}},r=function(e,t,n){this.id=e,this.x=t,this.y=n,this.range=50,this.radius=10},r.prototype={render:function(e){e.strokeStyle="#00ff00",e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2),e.closePath(),e.stroke()}},s=function(e,t){this.x=e,this.y=t,this.dx=0,this.dy=1,this.heading=0,this.maxHp=100,this.hp=this.maxHp,this.range=64,this.defaultTargetType="Orbs",this.target="none",this.radius=5,this.attack=4},s.prototype={step:function(){this.x+=this.dx,this.y+=this.dy},render:function(e){e.strokeStyle="#ff0000",e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2),e.closePath(),e.stroke()}};var t=function(){this.setUp()};t.prototype={setUp:function(){this.orbs=[],this.orbs.push(new r("o1",320,240)),this.orbs.push(new r("o2",100,250)),this.enemys=[];for(var e=0;e!=40;e++)this.enemys.push(new s(10*e,20));this.cellSize=32,this.cellX=14,this.cellY=7,this.boardPos={x:50,y:206},this.buildings=[],this.buildings.push(new i("p","tower",12,5,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s1","socket",0,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s2","socket",1,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s3","socket",2,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s4","socket",3,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s5","socket",4,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s6","socket",5,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s7","socket",6,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s8","socket",7,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s9","socket",8,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s10","socket",9,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s11","socket",10,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s12","socket",11,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s13","socket",12,0,this.boardPos.x,this.boardPos.y)),this.buildings.push(new i("s14","socket",13,0,this.boardPos.x,this.boardPos.y))},killBuilding:function(e){var t=0,n;t=0,n=this.buildings.length;while(t<n){if(this.buildings[t].id===e){this.buildings.splice(t,1);break}t++}t=0,n=this.enemys.length;while(t<n)this.enemys[t].target.id===e&&(this.enemys[t].target.id="none"),t++},updateEnemyAI:function(){var t,n,r=0,i=this.enemys.length,s=this.buildings.length,o,u;while(r<i)t=this.enemys[r],t.target==="none"&&(t.target=this.buildings[Math.floor(Math.random()*s)]),t.heading!=o&&(o=Number(Math.atan2(t.target.y+t.target.cellSize/2-t.y,t.target.x+t.target.cellSize/2-t.x).toFixed(2)),o<0&&(o+=Math.PI*2),u=e.findAngles(t.heading,o),u.clock<u.counter?t.heading-=.1:t.heading+=.1),t.heading>Math.PI*2&&(t.heading-=Math.PI*2),t.heading<0&&(t.heading+=Math.PI*2),t.heading=Number(t.heading.toFixed(2)),t.dx=Math.cos(t.heading)*5,t.dy=Math.sin(t.heading)*5,n=e.distance(t.target.x,t.target.y,t.x,t.y),n>t.range?t.step():(t.target.hp-=t.attack,t.target.hp<=0&&(this.killBuilding(t.target.id),t.target="none",s=this.buildings.length,this.checkForDefeat())),r++},checkForDefeat:function(){this.buildings.length===0&&this.setUp()},update:function(){this.updateEnemyAI()},render:function(t){this.renderGameBoard(t);var n=0,r=this.orbs.length,i;n=0,r=this.buildings.length;while(n<r)i=this.buildings[n],t.strokeStyle="#00ffff",t.strokeRect(i.x,i.y,i.cellSize,i.cellSize),t.fillStyle="#afafaf",t.fillRect(i.x,i.y,32,10),t.fillStyle="#00aa00",t.fillRect(i.x,i.y,Number(e.percent(i.hp,i.maxHp)/100)*32,10),n++;n=0,r=this.enemys.length;while(n<r)this.enemys[n].render(t),n++;t.fillStyle="#ffffff",t.fillText("enemy 0 heading: "+this.enemys[0].heading,50,50)},renderGameBoard:function(e){var t=0,n=0;e.strokeStyle="rgba(255,255,255,0.25)";while(n<this.cellY){t=0;while(t<this.cellX)e.strokeRect(t*this.cellSize+this.boardPos.x,n*this.cellSize+this.boardPos.y,this.cellSize,this.cellSize),t++;n++}}},i=function(e,t,n,r,i,s){this.id=e,this.typeIndex=t,this.cellSize=32,this.cellX=n,this.cellY=r,this.x=this.cellX*this.cellSize+i,this.y=this.cellY*this.cellSize+s,this.maxHp=100,this.hp=this.maxHp},i.prototype={},a={start:{update:function(){u=new o("app",["background","orbs"],640,480);var e=u.get("background");e.fillStyle="#000000",e.fillRect(0,0,u.width,u.height),n=new t,f="game"},render:function(){}},game:{update:function(){n.update()},render:function(){var e=u.get("orbs");e.clearRect(0,0,u.width,u.height),n.render(u.get("orbs"))}}},h=function(){new Date-l>=c&&(a[f].update(),a[f].render(),l=new Date),requestAnimationFrame(h)},h()})()

</script>