
<div id="app"></div>
<script>
(function(){var e,t,n,r,s,o,u,a,f,l="start",c=new Date,h=1,p,d=0,v=0,m=0,g=0;window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}}()),e={distance:function(e,t,n,r){return Math.sqrt(Math.pow(e-n,2)+Math.pow(t-r,2))},boundingBox:function(e,t,n,r,i,s,o,u){var a=!1;return e>i+o||e+n<i||t+r<s||t>s+u?a=!1:a=!0,a},percent:function(e,t){return e*100/t},findAngles:function(e,t){var n={};return n.clock=e-t,n.counter=t-e,n.clock<0&&(n.clock+=Math.PI*2),n.counter<0&&(n.counter+=Math.PI*2),n},bind:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)}},u=function(e,t,n,r){var i=0,s=t.length,o,u;this.canvas=[],this.context=[],this.width=n,this.height=r,this.layerNames={};while(i<s)o=document.createElement("canvas"),o.style.position="absolute",u=o.getContext("2d"),o.width=n,o.height=r,document.getElementById(e).appendChild(o),this.canvas.push(o),this.context.push(u),this.layerNames[t[i]]=i,i++},u.prototype={get:function(e,t){t===undefined&&(t="context");if(typeof e=="number")return this[t][e];if(typeof e=="string")return this[t][this.layerNames[e]]}},r=function(e,t){this.x=e,this.y=t,this.radius=10,this.socketed=!1,this.range=150,this.speed=2e3,this.slow=1,this.attack=8},o=function(e,t){this.x=e,this.y=t,this.dx=0,this.dy=1,this.heading=Math.random()*Math.PI*2,this.maxHp=100,this.hp=this.maxHp,this.range=64,this.defaultTargetType="Orbs",this.target="none",this.radius=5,this.attack=4},o.prototype={step:function(){this.x+=this.dx,this.y+=this.dy},render:function(e){e.strokeStyle="#ff0000",e.beginPath(),e.arc(this.x,this.y,this.radius,0,Math.PI*2),e.closePath(),e.stroke()}};var t=function(){this.user={x:0,y:0},this.grabed={orb:"none",homeIndex:0,homeX:0,homeY:0},this.setUp()};t.prototype={makeOrb:function(){var e,t,n=0,i=this.OI,s=i.cellX*i.cellY;while(n<s){if(i.orbs[n]===undefined){t=Math.floor(n/i.cellX),e=n%i.cellX,i.orbs.push(new r(i.offsetX+i.cellSize/2+i.cellSize*e,i.offsetY+i.cellSize/2+i.cellSize*t));return}n++}},userGrab:function(t,n){var t,n,r,i=this.OI,s=this.grabed,o=this.user;e.boundingBox(o.x,o.y,1,1,i.offsetX,i.offsetY,i.cellSize*i.cellX,i.cellSize*i.cellY)&&(t=Math.floor((o.x-i.offsetX)/i.cellSize),n=Math.floor((o.y-i.offsetY)/i.cellSize),r=n*this.OI.cellX+t,i.orbs[r]!==undefined&&(s.orb=i.orbs[r],s.homeX=s.orb.x,s.homeY=s.orb.y,s.socketed||(s.homeIndex=r)))},userRelease:function(t,n){var r=this.OI,s=this.grabed,o=this.user;s.orb!=="none"&&(e.boundingBox(o.x,o.y,1,1,this.PB.offsetX,this.PB.offsetY,this.PB.cellX*this.PB.cellSize,this.PB.cellY*this.PB.cellSize)?(t=Math.floor((o.x-this.PB.offsetX)/this.PB.cellSize),n=Math.floor((o.y-this.PB.offsetY)/this.PB.cellSize),i=n*this.PB.cellX+t,this.buildings[i]!==undefined?this.buildings[i].typeIndex===1?this.buildings[i].socketed===undefined?(s.orb.socketed=!0,s.orb.x=this.buildings[i].x+this.buildings[i].cellSize/2,s.orb.y=this.buildings[i].y+this.buildings[i].cellSize/2,this.buildings[i].socketed=s.orb,r.orbs[s.homeIndex]=undefined,console.log(this.buildings[i].x+","+this.buildings[i].y),console.log("orb socketed!"+i)):(s.orb.x=s.homeX,s.orb.y=s.homeY):(s.orb.x=s.homeX,s.orb.y=s.homeY):(s.orb.x=s.homeX,s.orb.y=s.homeY)):e.boundingBox(o.x,o.y,1,1,r.offsetX,r.offsetY,r.cellX*r.cellSize,r.cellY*r.cellSize)?(t=Math.floor((o.x-r.offsetX)/r.cellSize),n=Math.floor((o.y-r.offsetY)/r.cellSize),i=n*this.OI.cellX+t,r.orbs[i]===undefined?(r.orbs[i]=s.orb,r.orbs[i].x=r.offsetX+r.cellSize/2+t*r.cellSize,r.orbs[i].y=r.offsetY+r.cellSize/2+n*r.cellSize,r.orbs[s.homeIndex]=undefined):(s.orb.x=s.homeX,s.orb.y=s.homeY)):(s.orb.x=s.homeX,s.orb.y=s.homeY)),s.orb="none"},userMove:function(e,t){this.user.x=e,this.user.y=t,this.grabed.orb!=="none"&&(this.grabed.orb.x=this.user.x,this.grabed.orb.y=this.user.y)},setUp:function(){var e;this.PB={cellSize:32,cellX:14,cellY:7,offsetX:25,offsetY:231},this.OI={orbs:[],cellSize:32,cellX:4,cellY:4,offsetX:487,offsetY:327};for(e=0;e<8;e++)this.makeOrb();this.enemys=[];var t=Math.round(Math.random()*19)+1;for(e=0;e!=t;e++)this.enemys.push(new o(Math.round(Math.random()*500),-20));this.buildings=[];for(e=0;e!=13;e+=1)this.buildings.push(new s("s"+e,1,e,0,this.PB.offsetX,this.PB.offsetY));this.buildings.push(new s("p",0,12,5,this.PB.offsetX,this.PB.offsetY)),this.buildings[3].socketed=new r(this.buildings[3].x+this.buildings[3].cellSize/2,this.buildings[3].y+this.buildings[3].cellSize/2),this.buildings[7].socketed=new r(this.buildings[7].x+this.buildings[7].cellSize/2,this.buildings[7].y+this.buildings[7].cellSize/2),this.buildings[11].socketed=new r(this.buildings[11].x+this.buildings[11].cellSize/2,this.buildings[11].y+this.buildings[11].cellSize/2)},killBuilding:function(e){var t=0,n;t=0,n=this.buildings.length;while(t<n){if(this.buildings[t].id===e){this.buildings.splice(t,1);break}t++}t=0,n=this.enemys.length;while(t<n)this.enemys[t].target.id===e&&(this.enemys[t].target.id="none"),t++},killEnemy:function(e){this.enemys.splice(e,1)},updateEnemyAI:function(){var t,n,r=0,i=this.enemys.length,s=this.buildings.length,o,u;while(r<i)t=this.enemys[r],t.target==="none"&&(t.target=this.buildings[Math.floor(Math.random()*s)]),t.heading!=o&&(o=Number(Math.atan2(t.target.y+t.target.cellSize/2-t.y,t.target.x+t.target.cellSize/2-t.x).toFixed(2)),o<0&&(o+=Math.PI*2),u=e.findAngles(t.heading,o),u.clock<u.counter?t.heading-=.1:t.heading+=.1),t.heading>Math.PI*2&&(t.heading-=Math.PI*2),t.heading<0&&(t.heading+=Math.PI*2),t.heading=Number(t.heading.toFixed(2)),t.dx=Math.cos(t.heading)*5,t.dy=Math.sin(t.heading)*5,n=e.distance(t.target.x,t.target.y,t.x,t.y),n>t.range?t.step():(t.target.hp-=t.attack,t.target.hp<=0&&(this.killBuilding(t.target.id),t.target="none",s=this.buildings.length,this.checkForDefeat())),r++},updatePlayerAttack:function(){var t=0,n,r=this.buildings.length,i,s,o=this.enemys.length,u,a=[];while(t<r){n=this.buildings[t];if(n.socketed){u=n.socketed,i=0;while(i<o){s=this.enemys[i];if(e.distance(u.x,u.y,s.x,s.y)<u.range){s.hp-=u.attack,s.hp<=0&&(console.log("enemy has been killed!"),a.push(i)),console.log("building"+t+"'s orb is ready to attack! ");break}i++}}t++}t=0,r=a.length;while(t<r)this.killEnemy(a[t]),t++;this.checkForVictory()},checkForDefeat:function(){this.buildings.length===0&&(console.log("The player has lost"),g++,this.setUp())},checkForVictory:function(){console.log("checking"),this.enemys.length===0&&(console.log("The player has won"),m++,this.setUp())},update:function(){this.updateEnemyAI(),this.updatePlayerAttack()},render:function(t){var n,r,i;t.lineWidth=2,this.renderGL(this.PB,t),this.renderGL(this.OI,t),n=0,r=this.buildings.length;while(n<r){i=this.buildings[n];if(i!==undefined){t.strokeStyle="#00ffff",t.strokeRect(i.x,i.y,i.cellSize,i.cellSize);if(i.socketed){var s=i.socketed;t.fillStyle="#ff00ff",t.beginPath(),t.arc(s.x,s.y,s.radius,0,Math.PI*2),t.closePath(),t.fill()}t.fillStyle="#afafaf",t.fillRect(i.x,i.y,32,4),t.fillStyle="#00ff00",t.fillRect(i.x,i.y,Number(e.percent(i.hp,i.maxHp)/100)*32,4),n++}}n=0,r=this.OI.orbs.length;while(n<r)i=this.OI.orbs[n],i!==undefined&&(t.fillStyle="#ff00ff",t.beginPath(),t.arc(i.x,i.y,i.radius,0,Math.PI*2),t.closePath(),t.fill()),n++;n=0,r=this.enemys.length;while(n<r)i=this.enemys[n],i.render(t),t.strokeStyle="#00aa00",t.beginPath(),t.arc(i.x,i.y,8,0,Number(e.percent(i.hp,i.maxHp)/100)*Math.PI*2),t.stroke(),n++;t.fillStyle="#ffffff",t.fillText("win:"+m+", lost:"+g,10,10)},renderGL:function(e,t){var n=0,r=0;t.strokeStyle="rgba(255,255,255,0.25)";while(r<e.cellY){n=0;while(n<e.cellX)t.strokeRect(n*e.cellSize+e.offsetX,r*e.cellSize+e.offsetY,e.cellSize,e.cellSize),n++;r++}}},s=function(e,t,n,r,i,s){this.id=e,this.typeIndex=t,this.cellSize=32,this.cellX=n,this.cellY=r,this.x=this.cellX*this.cellSize+i,this.y=this.cellY*this.cellSize+s,this.maxHp=100,this.hp=this.maxHp,this.socketed},s.prototype={},f={start:{update:function(){var r;a=new u("app",["background","orbs","disp"],640,480),r=a.get("background"),r.fillStyle="#1a1a1a",r.fillRect(0,0,a.width,a.height),n=new t,function(){var t=a.get("disp","canvas");e.bind(t,"mousemove",function(e){var r=t.getBoundingClientRect();d=e.clientX-r.left,v=e.clientY-r.top,n.userMove(d,v)}),e.bind(t,"mousedown",function(e){var r=t.getBoundingClientRect();d=e.clientX-r.left,v=e.clientY-r.top,n.userGrab(d,v)}),e.bind(t,"mouseup",function(e){var r=t.getBoundingClientRect();d=e.clientX-r.left,v=e.clientY-r.top,n.userRelease(d,v)})}(),l="game"},render:function(){}},game:{update:function(){n.update()},render:function(){var e=a.get("orbs");e.clearRect(0,0,a.width,a.height),n.render(a.get("orbs"))}}},p=function(){new Date-c>=h&&(f[l].update(),f[l].render(),c=new Date),requestAnimationFrame(p)},p()})()

</script>